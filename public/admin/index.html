<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lumina Content Manager</title>
  
  <link href="config.yml" type="text/yaml" rel="cms-config-url">
</head>
<body>
  <!-- Use a specific version instead of ^3.0.0 to prevent 302 redirects and version conflicts -->
  <script src="https://unpkg.com/decap-cms@3.1.2/dist/decap-cms.js"></script>

  <script>
    // Manual Listener: Catches the auth token if Decap CMS misses it.
    window.addEventListener("message", (event) => {
      // 1. Strict Filter: Only accept messages that are strings and match the Decap CMS protocol
      if (typeof event.data !== 'string' || !event.data.startsWith("authorization:github:success:")) {
        return;
      }

      console.log("[Admin] Received Auth Message manually.");
      
      // 2. LOOP PREVENTION: Check if we are already authenticated.
      // If the token exists in LocalStorage, DO NOT reload again.
      const existingUser = localStorage.getItem("netlify-cms-user");
      if (existingUser) {
        try {
          const userData = JSON.parse(existingUser);
          if (userData.token) {
            console.log("[Admin] âœ… Token already exists. Stopping reload loop.");
            return; 
          }
        } catch (e) {
          // If JSON is invalid, proceed to overwrite it
          console.warn("[Admin] Existing token corrupted, overwriting.");
        }
      }
        
      // 3. Parse and Save
      try {
         const jsonStr = event.data.replace("authorization:github:success:", "");
         const data = JSON.parse(jsonStr);
         
         if (data.token) {
           const userObj = JSON.stringify({ token: data.token, backendName: 'github' });
           // Write to both keys to maximize compatibility
           localStorage.setItem("netlify-cms-user", userObj);
           localStorage.setItem("decap-cms-user", userObj);
           
           console.log("[Admin] ðŸ’¾ Token saved manually. Reloading CMS...");
           window.location.reload();
         }
      } catch(e) {
         console.error("[Admin] Manual auth parse error", e);
      }
    });
  </script>
</body>
</html>