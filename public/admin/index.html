
<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lumina Content Manager</title>
  
  <link href="config.yml" type="text/yaml" rel="cms-config-url">
</head>
<body>
  <!-- Use a robust, specific version to avoid redirects -->
  <script src="https://unpkg.com/decap-cms@3.1.2/dist/decap-cms.js"></script>

  <script>
    // Robust Auth Handler
    window.addEventListener("message", (event) => {
      // 1. Verify Origin (Optional but recommended for security)
      // if (event.origin !== "https://gemini.wildsalt.me") return;

      // 2. Strict Content Filter
      if (typeof event.data !== 'string' || !event.data.startsWith("authorization:github:success:")) {
        return;
      }

      console.log("[Admin] Received auth message.");

      try {
        const jsonStr = event.data.replace("authorization:github:success:", "");
        const data = JSON.parse(jsonStr);
        
        if (data.token) {
          // Store token in the format Decap CMS expects
          const userObj = JSON.stringify({ 
            token: data.token, 
            provider: 'github' 
          });
          
          localStorage.setItem("decap-cms-user", userObj);
          // Legacy support just in case
          localStorage.setItem("netlify-cms-user", userObj);
          
          console.log("[Admin] Token saved. Reloading interface...");
          
          // Force reload to clear any stale state
          setTimeout(() => {
             window.location.reload();
          }, 200);
        }
      } catch(e) {
        console.error("[Admin] Auth Error:", e);
      }
    });
  </script>
</body>
</html>
