<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lumina Content Manager</title>
  
  <link href="config.yml" type="text/yaml" rel="cms-config-url">
</head>
<body>
  <!-- Use a specific version instead of ^3.0.0 to prevent 302 redirects and version conflicts -->
  <script src="https://unpkg.com/decap-cms@3.1.2/dist/decap-cms.js"></script>

  <script>
    window.addEventListener("message", (event) => {
      // 1. Strict Filter
      if (typeof event.data !== 'string' || !event.data.startsWith("authorization:github:success:")) {
        return;
      }

      // 2. Loop Prevention: Check if valid token already exists
      const existing = localStorage.getItem("decap-cms-user") || localStorage.getItem("netlify-cms-user");
      if (existing) {
        try {
          if (JSON.parse(existing).token) {
            console.log("[Admin] âœ… Token exists. Loop stopped.");
            return; 
          }
        } catch (e) {}
      }

      // 3. Parse and Save
      try {
        const jsonStr = event.data.replace("authorization:github:success:", "");
        const data = JSON.parse(jsonStr);
        
        if (data.token) {
          // Fusion: Include both provider and backendName for maximum compatibility
          const userObj = JSON.stringify({ 
            token: data.token, 
            provider: 'github',
            backendName: 'github' 
          });
          
          localStorage.setItem("netlify-cms-user", userObj);
          localStorage.setItem("decap-cms-user", userObj);
          
          console.log("[Admin] ðŸ’¾ Token saved. Reloading...");
          // Added small delay to ensure storage write and fixed syntax
          setTimeout(() => window.location.reload(), 50);
        }
      } catch(e) {
        console.error("[Admin] Auth parse error", e);
      }
    });
  </script>
</body>
</html>