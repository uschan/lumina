<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lumina Content Manager</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
    #login-status {
      position: fixed; top: 20px; right: 20px; 
      padding: 10px 15px; background: rgba(0,0,0,0.8); color: white; 
      border-radius: 8px; font-size: 12px; z-index: 9999; display: none;
    }
  </style>
  <!-- Load js-yaml to parse config client-side (This fixes the Content-Type error) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
</head>
<body>
  <div id="login-status">Initializing...</div>

  <script>
    // 1. Disable auto-init so we can handle the config loading manually
    window.CMS_MANUAL_INIT = true;
  </script>
  
  <!-- 2. Load Decap CMS -->
  <script src="https://unpkg.com/decap-cms@^3.1.2/dist/decap-cms.js"></script>
  
  <script>
    const status = document.getElementById('login-status');
    const log = (msg) => { console.log("[Lumina CMS]", msg); status.innerText = msg; status.style.display = 'block'; };

    log("Starting manual boot sequence...");

    // 3. Manually fetch config.yml as TEXT.
    // This bypasses the Nginx "application/octet-stream" error because we ignore the header.
    fetch('config.yml?v=' + Date.now()) // Add timestamp to bust cache
      .then(response => {
        log("Config file found. Downloading...");
        return response.text(); 
      })
      .then(yamlText => {
        try {
          log("Parsing configuration...");
          // 4. Parse the YAML text into a JavaScript object
          const config = jsyaml.load(yamlText);
          
          // 5. Initialize the CMS with the parsed config
          CMS.init({ config });
          log("CMS Initialized.");
          setTimeout(() => { status.style.display = 'none'; }, 2000);
        } catch (e) {
          console.error(e);
          document.body.innerHTML = '<div style="color:red; padding:20px;"><h1>Config Error</h1><p>Failed to parse config.yml. Check console for details.</p><pre>' + e.message + '</pre></div>';
        }
      })
      .catch(error => {
        console.error(error);
        document.body.innerHTML = '<div style="color:red; padding:20px;"><h1>Load Error</h1><p>Failed to load config.yml.</p><pre>' + error.message + '</pre></div>';
      });
  </script>
</body>
</html>